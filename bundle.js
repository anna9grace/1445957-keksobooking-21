(()=>{"use strict";window.util={getRandomInt:(e=100,t=0)=>(t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t),getRandomArrayElement:e=>e[Math.floor(Math.random()*e.length)],onDataLoadError:e=>{const t=document.createElement("div");t.style.zIndex="100",t.style.textAlign="center",t.style.color="red",t.style.backgroundColor="white",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="20px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},debounce:(e,t=500)=>{let o=null;return(...n)=>{o&&window.clearTimeout(o),o=window.setTimeout((()=>{e(...n)}),t)}}},window.constants={MAX_CAPACITY:100,MAIN_PIN_POINTER_SIZE:22,accomodationType:{palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},MAIN_PIN_SIZE:65},window.backend={sendRequest:(e,t,o,n,r="")=>{const a=new XMLHttpRequest;a.responseType="json",a.open(t,e),a.send(r),a.addEventListener("load",(()=>{200===a.status?o(a.response):n(`Статус ответа: ${a.status} ${a.statusText}`)})),a.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),a.timeout=1e4,a.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${a.timeout} мс.`)}))}},(()=>{const e=["gif","png","jpeg","jpg"],t=document.querySelector("#avatar"),o=document.querySelector("#images"),n=document.querySelector(".ad-form-header__preview"),r=document.querySelector(".ad-form__photo"),a=(t,o)=>{const n=t.files[0],r=n.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;let t=o.querySelector("img");t||(t=(e=>{const t=document.createElement("img");return t.alt="Фотография жилья",t.setAttribute("width","70"),t.setAttribute("height","70"),e.insertAdjacentElement("afterbegin",t),t})(o)),e.addEventListener("load",(()=>{t.src=e.result})),e.readAsDataURL(n)}};t.addEventListener("change",a.bind(null,t,n)),o.addEventListener("change",a.bind(null,o,r))})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=e=>{const o=t.cloneNode(!0);return o.querySelector("img").src=e.author.avatar,o.querySelector("img").alt=e.offer.title,o.style.left=e.location.x-25+"px",o.style.top=e.location.y-70+"px",o};window.pin={renderMapPins:t=>{let n=5<t.length?5:t.length;for(let e of document.querySelectorAll(".map__pin:not(:first-of-type)"))e.remove();const r=document.createDocumentFragment();for(let e=0;e<n;e++)r.appendChild(o(t[e]));return e.appendChild(r)}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.querySelector(".map__filters-container");window.card={renderAdvertCard:o=>{const n=e.cloneNode(!0),r=n.querySelector(".popup__description"),a=n.querySelector(".popup__type"),d=n.querySelector(".popup__text--time"),i=n.querySelector(".popup__text--capacity"),s=n.querySelector(".popup__avatar"),c=n.querySelector(".popup__photos"),l=n.querySelector(".popup__features");return n.querySelector(".popup__title").textContent=o.offer.title,n.querySelector(".popup__text--price").textContent=o.offer.price+"₽/ночь",n.querySelector(".popup__text--address").textContent=o.offer.address,o.offer.description?r.textContent=o.offer.description:r.style.display="none",o.offer.type?a.textContent=window.constants.accomodationType[o.offer.type]:a.style.display="none",o.offer.checkin?d.textContent=`Заезд после ${o.offer.checkin}, выезд до ${o.offer.checkout}`:d.style.display="none",o.offer.rooms?i.textContent=(e=>{let t=" комната";e.offer.rooms<5&&1!==e.offer.rooms?t=" комнаты":e.offer.rooms>=5&&(t=" комнат");let o=1===e.offer.guests?" гостя":" гостей";return e.offer.rooms+t+" для "+e.offer.guests+o})(o):i.style.display="none",o.author.avatar?s.src=o.author.avatar:s.style.display="none",o.offer.photos.length>0?((e,t)=>{const o=e.querySelector(".popup__photos"),n=e.querySelector(".popup__photo"),r=document.createDocumentFragment();for(let e=0;e<t.offer.photos.length;e++){let o=n.cloneNode(!0);o.src=t.offer.photos[e],r.appendChild(o)}n.remove(),o.appendChild(r)})(n,o):c.style.display="none",o.offer.features.length>0?((e,t)=>{const o=e.querySelectorAll(".popup__feature");for(let e of o)e.style.display="none";t.offer.features.forEach((e=>{for(let t=0;t<o.length;t++)o[t].classList.contains("popup__feature--"+e)&&(o[t].style.display="")}))})(n,o):l.style.display="none",t.before(n)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main"),o=document.querySelector("#address"),n=e=>{0===e.button&&window.page.setActivePageState()},r=e=>{"Enter"===e.key&&window.page.setActivePageState()};t.addEventListener("mousedown",n),t.addEventListener("keydown",r);const a=()=>{const t=e.querySelector(".map__card");t&&(t.remove(),document.querySelector(".map__pin--active").classList.remove("map__pin--active"),document.removeEventListener("keydown",d))},d=e=>{"Escape"===e.key&&a()};window.map={renderPinCoordinates:(e=.5,n=0)=>{const r={};return r.x=Math.ceil(t.offsetLeft+.5*window.constants.MAIN_PIN_SIZE),r.y=Math.floor(t.offsetTop+window.constants.MAIN_PIN_SIZE*e+n),o.value=r.x+", "+r.y,r},showCurrentCard:(t,o)=>{const n=o.target.closest(".map__pin");n&&!n.classList.contains("map__pin--main")&&(a(),n.classList.add("map__pin--active"),((t,o)=>{const n=e.querySelectorAll(".map__pin:not(:first-of-type)");for(let e=0;e<n.length;e++)n[e]===o&&window.card.renderAdvertCard(t[e]);document.addEventListener("keydown",d),e.querySelector(".popup__close").addEventListener("click",(()=>{a()}))})(t,n))},onMainPinClick:n,onMainPinKeydown:r,closeAdvertCard:a}})(),(()=>{const e=window.constants.MAIN_PIN_SIZE+window.constants.MAIN_PIN_POINTER_SIZE,t=document.querySelector(".map"),o=document.querySelector(".map__pin--main"),n=130-e,r=630-e,a=0-window.constants.MAIN_PIN_SIZE/2,d=(e,t,n,r)=>{o.style[r]=e<t?t+"px":e>n?n+"px":e+"px"};o.addEventListener("mousedown",(e=>{e.preventDefault();const i={x:e.clientX,y:e.clientY},s=e=>{e.preventDefault();const s=i.x-e.clientX,c=i.y-e.clientY;i.x=e.clientX,i.y=e.clientY;const l={x:o.offsetLeft-s,y:o.offsetTop-c},u=t.offsetWidth-window.constants.MAIN_PIN_SIZE/2;d(l.x,a,u,"left"),d(l.y,n,r,"top"),window.map.renderPinCoordinates(1,window.constants.MAIN_PIN_POINTER_SIZE)},c=e=>{e.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",c)}))})(),(()=>{const e=document.querySelector(".map__filters"),t=document.querySelector("#housing-type"),o=document.querySelector("#housing-price"),n=document.querySelector("#housing-rooms"),r=document.querySelector("#housing-guests"),a={LOW:{MIN:0,MAX:9999},MIDDLE:{MIN:1e4,MAX:5e4},HIGH:{MIN:50001,MAX:1e7}},d=window.util.debounce((()=>{window.map.closeAdvertCard(),window.page.filteredAdverts=window.page.adverts.filter((d=>{return i=d,("any"===t.value||i.offer.type===t.value)&&(e=>"any"===o.value||e.offer.price<=a[o.value.toUpperCase()].MAX&&e.offer.price>=a[o.value.toUpperCase()].MIN)(d)&&(e=>"any"===n.value||e.offer.rooms.toString()===n.value)(d)&&(e=>"any"===r.value||e.offer.guests.toString()===r.value)(d)&&(t=>Array.from(e.querySelectorAll("input:checked")).every((e=>-1!==t.offer.features.indexOf(e.value))))(d);var i})),window.pin.renderMapPins(window.page.filteredAdverts)}));e.addEventListener("change",d)})(),(()=>{const e=document.querySelectorAll(".map__filters, .ad-form"),t=document.querySelector(".map"),o=document.querySelector(".ad-form"),n=document.querySelector(".map__filters"),r=document.querySelector(".map__pin--main"),a=o.querySelector(".ad-form__photo").innerHTML,d=o.querySelector(".ad-form-header__preview img").src,i=e=>{for(let t of e)t.setAttribute("disabled","disabled")},s=e=>{for(let t of e)t.removeAttribute("disabled")},c=e=>{window.map.showCurrentCard(window.page.filteredAdverts,e)},l=e=>{window.page.adverts=e,window.page.filteredAdverts=e,t.addEventListener("click",c),window.pin.renderMapPins(e),s(n)};window.page={setActivePageState:()=>{t.classList.remove("map--faded"),o.classList.remove("ad-form--disabled"),s(o),window.map.renderPinCoordinates(1,window.constants.MAIN_PIN_POINTER_SIZE),window.form.checkRoomsValidity(),window.backend.sendRequest("https://21.javascript.pages.academy/keksobooking/data","GET",l,window.util.onDataLoadError),r.removeEventListener("mousedown",window.map.onMainPinClick),r.removeEventListener("keydown",window.map.onMainPinKeydown)},disableFormFields:i,resetPage:()=>{for(let e of document.querySelectorAll(".map__pin:not(:first-of-type)"))e.remove();n.reset(),o.reset(),o.querySelector(".ad-form__photo").innerHTML=a,o.querySelector(".ad-form-header__preview img").src=d,r.style.left=window.main.mainPinDefaultPosition.x+"px",r.style.top=window.main.mainPinDefaultPosition.y+"px",window.form.checkPriceValidity(),window.map.closeAdvertCard(),window.map.renderPinCoordinates(.5,0),i(e),t.classList.add("map--faded"),o.classList.add("ad-form--disabled"),t.removeEventListener("click",c),r.addEventListener("mousedown",window.map.onMainPinClick),r.addEventListener("keydown",window.map.onMainPinKeydown)},adverts:[],filteredAdverts:[]}})(),(()=>{const e={PALACE:1e4,FLAT:1e3,HOUSE:5e3,BUNGALOW:0},t=document.querySelector(".ad-form"),o=t.querySelector("#room_number"),n=t.querySelector("#capacity"),r=t.querySelector("#price"),a=t.querySelector("#type"),d=t.querySelector("#timein"),i=t.querySelector("#timeout"),s=document.querySelector("#success").content.querySelector(".success"),c=document.querySelector("#error").content.querySelector(".error"),l=document.querySelector(".ad-form__reset"),u=()=>{let e=+o.value,t=+n.value;e===window.constants.MAX_CAPACITY&&0!==t?n.setCustomValidity("Это жилье не для гостей. Выберите подходящий вариант"):e!==window.constants.MAX_CAPACITY&&0===t?n.setCustomValidity("Выберите количество гостей"):2===e&&t>2?n.setCustomValidity("Подходит максимум для двух гостей. Выберите другой вариант"):1===e&&t>1?n.setCustomValidity("Подходит только для одного гостя. Выберите подходящий вариант"):n.setCustomValidity("")},p=()=>{const t=a.value;r.min=e[t.toUpperCase()],r.placeholder=e[t.toUpperCase()]};o.addEventListener("change",(()=>{u()})),n.addEventListener("change",(()=>{u()})),a.addEventListener("change",(()=>{p()})),d.addEventListener("change",(()=>{i.value=d.value})),i.addEventListener("change",(()=>{d.value=i.value}));const m=()=>{let e=document.querySelector(".success")||document.querySelector(".error");e&&e.remove(),document.removeEventListener("keydown",f),document.removeEventListener("click",m)},f=e=>{"Escape"===e.key&&m()},y=e=>{const t=e.cloneNode(!0);document.querySelector("main").insertAdjacentElement("afterbegin",t),document.addEventListener("keydown",f),document.addEventListener("click",m)},w=()=>{y(s),window.page.resetPage()},_=()=>{y(c);const e=document.querySelector(".error");e.setAttribute("tabindex","0"),e.focus(),e.style.outline="none"};t.addEventListener("submit",(e=>{e.preventDefault(),window.backend.sendRequest("https://21.javascript.pages.academy/keksobooking","POST",w,_,new FormData(t))})),l.addEventListener("click",(e=>{e.preventDefault(),window.page.resetPage()})),window.form={checkRoomsValidity:u,checkPriceValidity:p}})(),(()=>{const e=document.querySelectorAll(".map__features, .map__filter, .ad-form fieldset"),t=document.querySelector(".map__pin--main"),o={x:t.offsetLeft,y:t.offsetTop};window.page.disableFormFields(e),window.map.renderPinCoordinates(),window.main={mainPinDefaultPosition:o}})()})();